services:
  spark:
    image: apache/spark:3.5.0
    container_name: spark-master
    command: >
      /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master
    ports:
      - "8080:8080"
      - "7077:7077"
    environment:
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
    restart: unless-stopped
    healthcheck:
      test: ["CMD","sh","-c","curl -fsS http://localhost:8080/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  spark-worker:
    image: apache/spark:3.5.0
    container_name: spark-worker
    depends_on:
      - spark
    command: >
      /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark:7077
    ports:
      - "8081:8081"
    restart: unless-stopped

  app:
    build: .
    volumes:
      - ./:/usr/src/app
    working_dir: /usr/src/app
    depends_on:
      - spark
    environment:
      - PYTHONUNBUFFERED=1
      - SPARK_MASTER_URL=spark://spark:7077
    command: ["pytest","-q"]